<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>7th Chords Gen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
</head>
<body>

<header><h1>ðŸŽ· 7th Chords Gen</h1></header>

<div class="control-container">
  <div class="control-panel">
    <div class="mode-selector">
      <label><input type="radio" name="mode" value="random" checked> Random</label>
      <div class="random-options" id="randomOptions">
        <label><input type="checkbox" id="includeHalfDim" checked> include Ã¸7</label>
        <label><input type="checkbox" id="includeDim" checked> include Â°7</label>
      </div>
      <label><input type="radio" name="mode" value="maj251"> iiâ€“Vâ€“I (major)</label>
      <label><input type="radio" name="mode" value="min251"> iiÃ¸â€“Vâ€“i (minor)</label>
      <label><input type="radio" name="mode" value="cycle"> Cycle-of-Fifths</label>
    </div>
    <div class="button-column">
      <button class="play" id="playBtn" disabled>â–¶ Play</button>
      <button class="stats-btn" id="statsBtn">ðŸ“Š Stats</button>
    </div>
  </div>
  <button class="next-btn" id="nextBtn">ðŸŽµ Next</button>
</div>

<main>
  <div class="info-box" id="infoBox">
    <div class="pill key"><span class="pill-label">Key:</span> <span class="pill-value" id="keyLabel"></span></div>
    <div class="pill step"><span class="pill-label">Step:</span> <span class="pill-value" id="stepLabel"></span></div>
  </div>
  <div class="chord" id="chordDisplay"></div>
  <div class="stats-line" id="statsLine">Chords: <span id="statsCount">0</span></div>
</main>

<script>
"use strict";
(() => {
  const KEYS = {
    C:["C","D","E","F","G","A","B"], Db:["Db","Eb","F","Gb","Ab","Bb","C"],
    D:["D","E","F#","G","A","B","C#"], Eb:["Eb","F","G","Ab","Bb","C","D"],
    E:["E","F#","G#","A","B","C#","D#"], F:["F","G","A","Bb","C","D","E"],
    Gb:["Gb","Ab","Bb","Cb","Db","Eb","F"], G:["G","A","B","C","D","E","F#"],
    Ab:["Ab","Bb","C","Db","Eb","F","G"], A:["A","B","C#","D","E","F#","G#"],
    Bb:["Bb","C","D","Eb","F","G","A"], B:["B","C#","D#","E","F#","G#","A#"]
  };

  const CYCLE_FIFTHS = ["C","F","Bb","Eb","Ab","Db","Gb","B","E","A","D","G"];
  const PROGS = {
    maj251:[{step:"ii",quality:"m7",deg:1},{step:"V",quality:"7",deg:4},{step:"I",quality:"maj7",deg:0}],
    min251:[{step:"iiÃ¸",quality:"Ã¸7",deg:1},{step:"V",quality:"7",deg:4,harmonic:true},{step:"i",quality:"m7",deg:0}]
  };

  const INTERVALS = { maj7:[0,4,7,11], m7:[0,3,7,10], 7:[0,4,7,10], Ã¸7:[0,3,6,10], o7:[0,3,6,9] };
  const SEMI = ["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B"];
  const pick = a => a[Math.floor(Math.random()*a.length)];
  const fmt = s => s.replace(/#/g,"<sup>â™¯</sup>").replace(/b/g,"<sup>â™­</sup>");

  let currentMode="random", stepIndex=0, cycleIndex=Math.floor(Math.random()*CYCLE_FIFTHS.length),
      chordCount=0, currentChord=null, currentKey=null;

  const el = id => document.getElementById(id);
  const chordEl=el("chordDisplay"), playBtn=el("playBtn"), nextBtn=el("nextBtn");
  const statsBtn=el("statsBtn"), statsLine=el("statsLine"), statsCount=el("statsCount");
  const infoBox=el("infoBox"), keyLabel=el("keyLabel"), stepLabel=el("stepLabel");
  const randomOptions=el("randomOptions"), includeHalfDim=el("includeHalfDim"), includeDim=el("includeDim");

  const randomQualities = () => {
    const q=["maj7","m7","7"];
    if(includeHalfDim.checked) q.push("Ã¸7");
    if(includeDim.checked) q.push("o7");
    return q;
  };

  function render(ch){
    chordEl.innerHTML =
      fmt(ch.root) +
      (ch.quality==="maj7"?"<span class='qual'>maj</span><sup>7</sup>":
       ch.quality==="m7"?"<span class='qual'>m</span><sup>7</sup>":
       ch.quality==="Ã¸7"?"<sup>Ã¸</sup><sup>7</sup>":
       ch.quality==="o7"?"<sup>Â°</sup><sup>7</sup>":"<sup>7</sup>");
  }

  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const MIN_MIDI = 60;

  function playChord(chord){
    if(!chord) return;
    const base=MIN_MIDI + SEMI.indexOf(chord.root);
    let notes=INTERVALS[chord.quality].map(i=>base+i);
    if(chord.harmonic && chord.quality==="7") notes[1]+=1;
    notes.sort((a,b)=>a-b);
    const step = 0.3, dur = 0.5, t0=ctx.currentTime;
    notes.forEach((m,i)=>{
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.frequency.value=440*Math.pow(2,(m-69)/12);
      g.gain.setValueAtTime(0, t0+i*step);
      g.gain.linearRampToValueAtTime(0.25, t0+i*step+0.05);
      g.gain.linearRampToValueAtTime(0, t0+i*step+dur);
      o.connect(g).connect(ctx.destination);
      o.start(t0+i*step); o.stop(t0+i*step+dur);
    });
    const blockTime = t0+notes.length*step+2*step;
    notes.forEach(m=>{
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.frequency.value=440*Math.pow(2,(m-69)/12);
      g.gain.setValueAtTime(0, blockTime);
      g.gain.linearRampToValueAtTime(0.25, blockTime+0.05);
      g.gain.linearRampToValueAtTime(0, blockTime+dur);
      o.connect(g).connect(ctx.destination);
      o.start(blockTime); o.stop(blockTime+dur);
    });
  }

  function nextChord(){
    if(currentMode==="random"){
      const k=pick(Object.keys(KEYS));
      currentChord={root:pick(KEYS[k]), quality:pick(randomQualities())};
      infoBox.style.display="none";
    } else if(currentMode==="cycle"){
      const k=CYCLE_FIFTHS[cycleIndex++%CYCLE_FIFTHS.length];
      currentChord={root:KEYS[k][0], quality:"7"};
      infoBox.style.display="none";
    } else if (currentMode === "maj251" || currentMode === "min251") {
        if(stepIndex === 0) currentKey = pick(Object.keys(KEYS));
        const p = PROGS[currentMode][stepIndex];
        currentChord = { root: KEYS[currentKey][p.deg], quality: p.quality, harmonic: p.harmonic };

        // ONLY set the .pill-value, leave .pill-label in HTML
        keyLabel.textContent = fmt(currentKey) + (currentMode === "min251" ? "m" : "");
        stepLabel.textContent = p.step;

        infoBox.style.display = "flex";
        stepIndex = (stepIndex + 1) % 3;
     }
    render(currentChord);
    playBtn.disabled=false;
    statsCount.textContent=++chordCount;
  }

  document.querySelectorAll("input[name=mode]").forEach(r=>{
    r.addEventListener("change",()=>{
      currentMode=r.value; stepIndex=0; currentChord=null;
      chordEl.textContent=""; playBtn.disabled=true;
      randomOptions.style.display=currentMode==="random"?"flex":"none";
      infoBox.style.display="none";
    });
  });

  nextBtn.addEventListener("mousedown",()=>{nextChord();});
  playBtn.addEventListener("mousedown",()=>playChord(currentChord));
  statsBtn.addEventListener("mousedown",()=>statsLine.style.display=statsLine.offsetParent?"none":"block");

  document.addEventListener("keydown",e=>{
    if(e.code==="Space"){ e.preventDefault(); nextChord(); }
    if(e.key==="p" && !playBtn.disabled) playChord(currentChord);
    if(e.key==="s") statsLine.style.display=statsLine.offsetParent?"none":"block";
  });
})();
</script>
</body>
</html>

